name: "Bump version and create release"
description: "Bumps version, creates a tag, and publishes a release."

inputs:
  github_token:
    description: "GitHub token for authentication"
    required: true
  python_version:
    description: 'Python version to use for the build'
    required: false
    default: '3.12'

runs:
  using: "composite"
  steps:
    - name: Bump version and tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.2
      with:
        github_token: ${{ inputs.github_token }}

    - name: Create GitHub release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_version.outputs.new_tag }}
        generate_release_notes: true

    #- name: Set output
    #  shell: bash
    #  run: echo "tag=${{ steps.tag_version.outputs.new_tag }}" >> $GITHUB_ENV

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python_version }}

    - name: Install hatch
      shell: bash
      run: |
        pip install hatch

    # The Build package step updates the version in pyproject.toml
    # using the newly generated tag and then runs hatch build to create
    # the distribution.
    - name: Build package
      shell: bash
      run: |
        echo "Environment ${{ steps.tag_version.outputs.new_tag }}"
        sed -i "s/0.0.0/${{ steps.tag_version.outputs.new_tag }}/" pyproject.toml
        # Constructs the dist folder
        hatch build

    # The build output is uploaded and eventually picked up
    # for publication on PyPI
    - uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist
